From 2a3e463aa8fcd37ce77878a338f898e023e08981 Mon Sep 17 00:00:00 2001
From: Tianyi Hu <hutianyi@bytedance.com>
Date: Wed, 15 Sep 2021 21:43:18 +0800
Subject: [PATCH 1/2] [android-12.0.0_r18] Hide overlay on KeyChainActivity

Hide non system overlay to improve security.

Test: N/A
Bug: 199754277
Change-Id: Ia0e97f40d79a7f89035572e0175990694870938f
---
 AndroidManifest.xml                            | 1 +
 src/com/android/keychain/KeyChainActivity.java | 3 +++
 2 files changed, 4 insertions(+)

diff --git a/AndroidManifest.xml b/AndroidManifest.xml
index fae32b6..dcd8123 100755
--- a/AndroidManifest.xml
+++ b/AndroidManifest.xml
@@ -6,6 +6,7 @@
     <!-- Needed so KeyChainService on non-system user can write 
          security logging events -->
     <uses-permission android:name="android.permission.READ_LOGS"/>
+    <uses-permission android:name="android.permission.HIDE_NON_SYSTEM_OVERLAY_WINDOWS"/>
 
     <application android:label="@string/app_name"
             android:allowBackup="false"
diff --git a/src/com/android/keychain/KeyChainActivity.java b/src/com/android/keychain/KeyChainActivity.java
index 105dc6a..9c84731 100644
--- a/src/com/android/keychain/KeyChainActivity.java
+++ b/src/com/android/keychain/KeyChainActivity.java
@@ -77,6 +77,8 @@ import java.util.stream.Collectors;
 
 import javax.security.auth.x500.X500Principal;
 
+import static android.view.WindowManager.LayoutParams.SYSTEM_FLAG_HIDE_NON_SYSTEM_OVERLAY_WINDOWS;
+
 public class KeyChainActivity extends AppCompatActivity {
     private static final String TAG = "KeyChain";
 
@@ -128,6 +130,7 @@ public class KeyChainActivity extends AppCompatActivity {
     protected void onCreate(Bundle savedState) {
         super.onCreate(savedState);
         setContentView(R.layout.keychain_activity);
+        getWindow().addSystemFlags(SYSTEM_FLAG_HIDE_NON_SYSTEM_OVERLAY_WINDOWS);
     }
 
     @Override public void onResume() {
-- 
2.34.0

