From 604b49eec59c0d4d059f4dfba3b7478b6486e035 Mon Sep 17 00:00:00 2001
From: Bruno Martins <bgcngm@gmail.com>
Date: Sun, 19 Apr 2020 15:14:42 +0100
Subject: [PATCH] liblog: Always report as debuggable when building
 userdebug/eng

This doesn't affect the normal behavior of our builds, because
ro.debuggable is set to 1 on userdebug/eng anyway.

However, it's helpful because making __android_log_is_debuggable
return a compile time value rather than the value of runtime prop
lets us pass checks that'd otherwise prevent us from using adb root
when Magisk is installed.

Change-Id: I36f53976162e652a38008ced459ca02fd6c0af51
---
 liblog/Android.bp     | 5 +++++
 liblog/properties.cpp | 4 ++++
 2 files changed, 9 insertions(+)

diff --git a/liblog/Android.bp b/liblog/Android.bp
index e4d8a589..ec1b35f3 100644
--- a/liblog/Android.bp
+++ b/liblog/Android.bp
@@ -148,6 +148,11 @@ cc_library {
         "-DLIBLOG_LOG_TAG=1006",
         "-DSNET_EVENT_LOG_TAG=1397638484",
     ],
+    product_variables: {
+        debuggable: {
+            cflags: ["-DDEBUGGABLE"],
+        },
+    },
     logtags: ["event.logtags"],
     compile_multilib: "both",
     apex_available: [
diff --git a/liblog/properties.cpp b/liblog/properties.cpp
index bd5f5e7a..a137d49a 100644
--- a/liblog/properties.cpp
+++ b/liblog/properties.cpp
@@ -262,12 +262,16 @@ int __android_log_is_loggable(int prio, const char* tag, int default_prio) {
 }
 
 int __android_log_is_debuggable() {
+#ifdef DEBUGGABLE
+  return 1;
+#else
   static int is_debuggable = [] {
     char value[PROP_VALUE_MAX] = {};
     return __system_property_get("ro.debuggable", value) > 0 && !strcmp(value, "1");
   }();
 
   return is_debuggable;
+#endif
 }
 
 /*
-- 
2.34.1

